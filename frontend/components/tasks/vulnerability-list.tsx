"use client"

import { useEffect, useState } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import {
    Shield,
    AlertTriangle,
    Info,
    AlertCircle,
    ExternalLink,
    Search,
    Filter,
    ChevronDown,
    ChevronUp,
    Download,
    FileText,
    Code
} from "lucide-react"
import { cn } from "@/lib/utils"

interface Vulnerability {
    id: string
    cve_id: string
    severity: string
    cvss_score: number
    cvss_vector: string
    description: string
    service_name: string
    service_version: string
    port: number
    protocol: string
    status: string
    published_date: string | null
    last_modified_date: string | null
    references: any[]
    remediation: string | null
    discovered_at: string
}

interface VulnerabilityListProps {
    taskId: string
}

const severityConfig = {
    CRITICAL: {
        label: "严重",
        color: "bg-red-600 text-white",
        icon: AlertCircle,
        bgLight: "bg-red-50 dark:bg-red-950/20",
        borderColor: "border-red-200 dark:border-red-800"
    },
    HIGH: {
        label: "高危",
        color: "bg-orange-500 text-white",
        icon: AlertTriangle,
        bgLight: "bg-orange-50 dark:bg-orange-950/20",
        borderColor: "border-orange-200 dark:border-orange-800"
    },
    MEDIUM: {
        label: "中危",
        color: "bg-yellow-500 text-white",
        icon: AlertTriangle,
        bgLight: "bg-yellow-50 dark:bg-yellow-950/20",
        borderColor: "border-yellow-200 dark:border-yellow-800"
    },
    LOW: {
        label: "低危",
        color: "bg-blue-500 text-white",
        icon: Info,
        bgLight: "bg-blue-50 dark:bg-blue-950/20",
        borderColor: "border-blue-200 dark:border-blue-800"
    }
}

export function VulnerabilityList({ taskId }: VulnerabilityListProps) {
    const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([])
    const [statistics, setStatistics] = useState<any>(null)
    const [loading, setLoading] = useState(true)
    const [severityFilter, setSeverityFilter] = useState<string>("")
    const [serviceFilter, setServiceFilter] = useState<string>("")
    const [searchQuery, setSearchQuery] = useState("")
    const [expandedVuln, setExpandedVuln] = useState<string | null>(null)
    const [page, setPage] = useState(1)
    const [total, setTotal] = useState(0)

    useEffect(() => {
        fetchVulnerabilities()
    }, [taskId, severityFilter, serviceFilter, page])

    const fetchVulnerabilities = async () => {
        setLoading(true)
        try {
            const params = new URLSearchParams({
                page: page.toString(),
                page_size: '20'
            })

            if (severityFilter) params.append('severity', severityFilter)
            if (serviceFilter) params.append('service', serviceFilter)

            const response = await fetch(`http://localhost:8000/api/v1/tasks/${taskId}/vulnerabilities?${params}`)
            const data = await response.json()

            if (data.code === 200) {
                setVulnerabilities(data.data.vulnerabilities || [])
                setStatistics(data.data.statistics)
                setTotal(data.data.total)
            }
        } catch (error) {
            console.error("Failed to fetch vulnerabilities:", error)
        } finally {
            setLoading(false)
        }
    }

    const handleExport = async (format: 'csv' | 'json') => {
        try {
            const params = new URLSearchParams({ format })
            if (severityFilter) params.append('severity', severityFilter)

            const response = await fetch(`http://localhost:8000/api/v1/tasks/${taskId}/vulnerabilities/export?${params}`)

            if (response.ok) {
                const blob = await response.blob()
                const url = window.URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url

                // Extract filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition')
                const filename = contentDisposition?.split('filename=')[1] || `vulnerabilities.${format}`

                a.download = filename
                document.body.appendChild(a)
                a.click()
                window.URL.revokeObjectURL(url)
                document.body.removeChild(a)
            } else {
                console.error('Export failed:', response.statusText)
            }
        } catch (error) {
            console.error('Export error:', error)
        }
    }

    const filteredVulnerabilities = vulnerabilities.filter(vuln =>
        searchQuery === "" ||
        vuln.cve_id.toLowerCase().includes(searchQuery.toLowerCase()) ||
        vuln.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
        vuln.service_name.toLowerCase().includes(searchQuery.toLowerCase())
    )

    const getCVSSLevel = (score: number) => {
        if (score >= 9.0) return "CRITICAL"
        if (score >= 7.0) return "HIGH"
        if (score >= 4.0) return "MEDIUM"
        return "LOW"
    }

    if (loading) {
        return <div className="text-center py-8">加载漏洞数据中...</div>
    }

    return (
        <div className="space-y-4">
            {/* Statistics Cards */}
            {statistics && (
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <Card>
                        <CardContent className="p-4">
                            <div className="text-2xl font-bold">{statistics.total_vulnerabilities}</div>
                            <div className="text-sm text-muted-foreground">总漏洞数</div>
                        </CardContent>
                    </Card>
                    <Card className="border-red-200 dark:border-red-800">
                        <CardContent className="p-4">
                            <div className="text-2xl font-bold text-red-600">{statistics.critical}</div>
                            <div className="text-sm text-muted-foreground">严重</div>
                        </CardContent>
                    </Card>
                    <Card className="border-orange-200 dark:border-orange-800">
                        <CardContent className="p-4">
                            <div className="text-2xl font-bold text-orange-600">{statistics.high}</div>
                            <div className="text-sm text-muted-foreground">高危</div>
                        </CardContent>
                    </Card>
                    <Card className="border-yellow-200 dark:border-yellow-800">
                        <CardContent className="p-4">
                            <div className="text-2xl font-bold text-yellow-600">{statistics.medium}</div>
                            <div className="text-sm text-muted-foreground">中危</div>
                        </CardContent>
                    </Card>
                    <Card className="border-blue-200 dark:border-blue-800">
                        <CardContent className="p-4">
                            <div className="text-2xl font-bold text-blue-600">{statistics.low}</div>
                            <div className="text-sm text-muted-foreground">低危</div>
                        </CardContent>
                    </Card>
                </div>
            )}

            {/* Filters */}
            <Card>
                <CardContent className="p-4">
                    <div className="flex flex-col md:flex-row gap-4">
                        <div className="flex-1 relative">
                            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                            <Input
                                placeholder="搜索CVE ID、描述或服务..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="pl-10"
                            />
                        </div>
                        <Select value={severityFilter} onValueChange={setSeverityFilter}>
                            <SelectTrigger className="w-full md:w-[180px]">
                                <Filter className="h-4 w-4 mr-2" />
                                <SelectValue placeholder="严重程度" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value=" ">全部</SelectItem>
                                <SelectItem value="CRITICAL">严重</SelectItem>
                                <SelectItem value="HIGH">高危</SelectItem>
                                <SelectItem value="MEDIUM">中危</SelectItem>
                                <SelectItem value="LOW">低危</SelectItem>
                            </SelectContent>
                        </Select>

                        <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                                <Button variant="outline" className="w-full md:w-auto">
                                    <Download className="h-4 w-4 mr-2" />
                                    导出
                                </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end">
                                <DropdownMenuLabel>选择格式</DropdownMenuLabel>
                                <DropdownMenuSeparator />
                                <DropdownMenuItem onClick={() => handleExport('csv')}>
                                    <FileText className="h-4 w-4 mr-2" />
                                    CSV (Excel)
                                </DropdownMenuItem>
                                <DropdownMenuItem onClick={() => handleExport('json')}>
                                    <Code className="h-4 w-4 mr-2" />
                                    JSON
                                </DropdownMenuItem>
                            </DropdownMenuContent>
                        </DropdownMenu>
                    </div>
                </CardContent>
            </Card>

            {/* Vulnerability List */}
            <div className="space-y-3">
                {filteredVulnerabilities.length === 0 ? (
                    <Card>
                        <CardContent className="p-8 text-center text-muted-foreground">
                            未发现漏洞
                        </CardContent>
                    </Card>
                ) : (
                    filteredVulnerabilities.map((vuln) => {
                        const config = severityConfig[vuln.severity as keyof typeof severityConfig]
                        const Icon = config?.icon || Shield
                        const isExpanded = expandedVuln === vuln.id

                        return (
                            <Card
                                key={vuln.id}
                                className={cn(
                                    "transition-all hover:shadow-md",
                                    config?.borderColor
                                )}
                            >
                                <CardHeader className="pb-3">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <CardTitle className="text-lg">{vuln.cve_id || 'Unknown CVE'}</CardTitle>
                                                <Badge className={config?.color}>
                                                    {config?.label || vuln.severity}
                                                </Badge>
                                                {vuln.cvss_score && (
                                                    <Badge variant="outline" className="font-mono">
                                                        CVSS {vuln.cvss_score.toFixed(1)}
                                                    </Badge>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-4 mt-2 text-sm text-muted-foreground">
                                                <span>{vuln.service_name}</span>
                                                {vuln.port && <span>端口 {vuln.port}/{vuln.protocol}</span>}
                                                {vuln.service_version && <span>版本 {vuln.service_version}</span>}
                                            </div>
                                        </div>
                                        <Button
                                            variant="ghost"
                                            size="sm"
                                            onClick={() => setExpandedVuln(isExpanded ? null : vuln.id)}
                                        >
                                            {isExpanded ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}
                                        </Button>
                                    </div>
                                </CardHeader>
                                <CardContent className="pt-0">
                                    <p className="text-sm line-clamp-2">{vuln.description}</p>

                                    {isExpanded && (
                                        <div className="mt-4 space-y-3 pt-3 border-t">
                                            <div>
                                                <h4 className="font-semibold text-sm mb-1">完整描述</h4>
                                                <p className="text-sm text-muted-foreground">{vuln.description}</p>
                                            </div>

                                            {vuln.cvss_vector && (
                                                <div>
                                                    <h4 className="font-semibold text-sm mb-1">CVSS向量</h4>
                                                    <code className="text-xs bg-muted px-2 py-1 rounded">{vuln.cvss_vector}</code>
                                                </div>
                                            )}

                                            {vuln.references && vuln.references.length > 0 && (
                                                <div>
                                                    <h4 className="font-semibold text-sm mb-1">参考链接</h4>
                                                    <div className="space-y-1">
                                                        {vuln.references.slice(0, 3).map((ref: any, idx: number) => (
                                                            <a
                                                                key={idx}
                                                                href={ref.url}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="flex items-center gap-1 text-xs text-primary hover:underline"
                                                            >
                                                                <ExternalLink className="h-3 w-3" />
                                                                {ref.url}
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {vuln.published_date && (
                                                <div className="text-xs text-muted-foreground">
                                                    发布日期: {new Date(vuln.published_date).toLocaleDateString('zh-CN')}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </CardContent>
                            </Card>
                        )
                    })
                )}
            </div>

            {/* Pagination */}
            {total > 20 && (
                <div className="flex justify-center gap-2">
                    <Button
                        variant="outline"
                        size="sm"
                        disabled={page === 1}
                        onClick={() => setPage(p => p - 1)}
                    >
                        上一页
                    </Button>
                    <div className="flex items-center px-4 text-sm">
                        第 {page} 页 / 共 {Math.ceil(total / 20)} 页
                    </div>
                    <Button
                        variant="outline"
                        size="sm"
                        disabled={page >= Math.ceil(total / 20)}
                        onClick={() => setPage(p => p + 1)}
                    >
                        下一页
                    </Button>
                </div>
            )}
        </div>
    )
}
