# **EN 18031 网络安全检测平台 \- 后端系统详细设计说明书**

文档版本: v2.1 (Unified Python Edition)  
状态: Released  
技术策略: 全栈 Python (FastAPI \+ Celery)  
适用标准: EN 18031, ISO 17025, ETSI EN 303 645  
关联文档: BACKEND-API.md, RBAC-DESIGN.md, USER-GUIDE.md

## **1\. 系统总体架构 (System Architecture)**

### **1.1 架构设计理念**

系统采用 **"统一技术栈微服务 (Unified Stack Microservices)"** 架构。

* **统一语言**: 业务逻辑与安全工具调用全部使用 **Python**，共享数据模型 (Pydantic Models) 与工具库。  
* **逻辑分离**: 尽管语言统一，但在部署上依然保持 **LIMS Core** (IO密集型/Web) 与 **Sec Workers** (CPU密集型/任务) 的物理分离，通过消息队列解耦。

### **1.2 核心架构拓扑图**

graph TD  
    Client\[前端 Web / 移动端\] \--\> Gateway\[Nginx / API Gateway\]  
      
    subgraph "后端集群 (Backend Cluster \- Python)"  
        Gateway \--\> AuthSvc\[认证服务 (FastAPI)\]  
        Gateway \--\> BizCore\[LIMS 核心服务 (FastAPI)\]  
        Gateway \--\> WSSvc\[消息推送服务 (FastAPI WebSocket)\]  
          
        BizCore \--\> DB\_SQL\[(PostgreSQL)\]  
        BizCore \--\> Redis\_Cache\[(Redis)\]  
        BizCore \--\> MinIO\[对象存储\]  
    end

    subgraph "异步任务集群 (Async Task Cluster)"  
        BizCore \--"1. Celery Task"--\> MQ\[(RabbitMQ)\]  
          
        MQ \--\> Sched\[Celery Beat 调度器\]  
          
        MQ \--\> Queue\_High\[Q: 优先队列\]  
        MQ \--\> Queue\_Net\[Q: 网络扫描\]  
        MQ \--\> Queue\_Firm\[Q: 固件分析\]  
          
        subgraph "执行单元 (Python Workers)"  
            Worker\_Net\[Worker: NetScan\] \--\> Tool\_1\[Nmap/OpenVAS\]  
            Worker\_Firm\[Worker: Firmware\] \--\> Tool\_2\[FACT/Binwalk\]  
            Worker\_Fuzz\[Worker: Fuzzer\] \--\> Tool\_3\[Boofuzz/Scapy\]  
              
            Worker\_Net \--"2. 实时日志"--\> Redis\_PubSub\[(Redis Pub/Sub)\]  
            Worker\_Net \--"3. 结果存库"--\> DB\_NoSQL\[(MongoDB)\]  
        end  
    end

    subgraph "物理交互层 (Physical Layer)"  
        MQ \--\> Queue\_HW\[Q: 硬件指令\]  
        Queue\_HW \--\> Worker\_HW\[硬件控制 Worker\]  
        Worker\_HW \<--\>|WebSocket| Probe\_Agent\[树莓派探针 Agent\]  
        Probe\_Agent \--\> DUT\[被测设备\]  
    end

### **1.3 技术栈选型 (全栈 Python)**

| 模块 | 角色 | 推荐技术 | 核心理由 |
| :---- | :---- | :---- | :---- |
| **Web 框架** | API / 业务逻辑 | **FastAPI (Python 3.10+)** | 高性能异步框架，原生支持 Pydantic 数据验证，自动生成 Swagger 文档。 |
| **ORM** | 数据库交互 | **SQLAlchemy (Async)** | Python 领域最强 ORM，支持异步 IO，配合 Alembic 做版本迁移。 |
| **Task Queue** | 任务调度 | **Celery** | 分布式任务队列事实标准，与 Python 生态完美融合。 |
| **Report** | 报告引擎 | **Docxtpl \+ Matplotlib** | 直接利用 Python 强大的数据处理和模板渲染能力，无需跨语言调用。 |
| **Runtime** | 运行环境 | **Docker / K8s** | 容器化部署，隔离业务环境与安全工具环境。 |

## **2\. 业务域详细设计 (LIMS Core)**

### **2.1 核心服务实现 (FastAPI)**

#### **2.1.1 项目结构**

/app  
  /api          \# 路由定义 (Routers)  
  /core         \# 全局配置 (Config, Security)  
  /models       \# 数据库模型 (SQLAlchemy)  
  /schemas      \# 数据交互模型 (Pydantic)  
  /services     \# 业务逻辑 (ProjectService, ReportService)  
  /tasks        \# Celery 任务定义  
  /utils        \# 工具类 (ReportGenerator)

#### **2.1.2 审批流实现 (State Machine)**

使用 Python 的轻量级状态机库，而不是复杂的 BPMN 引擎，更适合本系统的规模。

* **库**: transitions 或纯代码实现。  
* **逻辑**: 在 ReportService 中定义状态流转规则。  
  \# 伪代码示例  
  class ReportStateMachine:  
      def review(self, report, action, user):  
          if report.status \!= 'pending\_review':  
              raise StateError("报告不在审核状态")  
          if action \== 'approve':  
              report.status \= 'approved'  
          elif action \== 'reject':  
              report.status \= 'draft'  
          report.audit\_logs.append(...)  
          db.commit()

### **2.2 报告生成引擎 (Docxtpl)**

这是全栈 Python 方案的最大优势。

* **流程**:  
  1. **准备数据**: 使用 SQLAlchemy 从 PG 获取项目信息，PyMongo 从 MongoDB 获取漏洞列表。  
  2. **生成图表**: 使用 matplotlib 或 seaborn 在内存中生成漏洞分布饼图 (BytesIO)。  
  3. **渲染模板**:  
     from docxtpl import DocxTemplate, InlineImage

     def generate\_report(project\_id):  
         doc \= DocxTemplate("templates/en18031\_master.docx")  
         context \= {  
             'project\_code': 'PRJ-2024-001',  
             'vuln\_table': vulnerabilities\_list,  
             'risk\_chart': InlineImage(doc, risk\_chart\_bytes, width=Mm(100))  
         }  
         doc.render(context)  
         doc.save(f"/tmp/{project\_id}.docx")

  4. **转 PDF**: 调用 libreoffice 容器服务进行转换。

## **3\. 执行域详细设计 (Execution Engine)**

### **3.1 Worker-Wrapper-Tool 设计**

保持原设计，但现在的集成更加原生。Wrapper 类可以直接引用业务域的 Pydantic 模型，保证数据结构一致性。

* **Wrapper 基类**:  
  class BaseToolWrapper(abc.ABC):  
      async def run(self):  
          \# 1\. Build Command  
          \# 2\. Subprocess.Popen  
          \# 3\. Redis Publish Logs  
          \# 4\. Parse Result to Pydantic Model  
          pass

### **3.2 任务队列策略**

* **队列隔离**:  
  * celery \-A app.tasks worker \-Q firmware\_queue \-c 2 (固件分析，低并发)  
  * celery \-A app.tasks worker \-Q network\_queue \-c 20 (网络扫描，高并发)  
* **超时控制**: 在 Celery Task 装饰器中设置 time\_limit=3600 (1小时)，防止任务死锁。

## **4\. 硬件交互设计 (Agent)**

### **4.1 探针 Agent (Python)**

运行在树莓派上的独立 Python 脚本。

* **依赖**: websockets, pyserial, RPi.GPIO.  
* **功能**:  
  1. **指令执行**: 接收 start\_wifi\_scan 等指令。  
  2. **弹性测试 (Resilience)**:  
     * 当 Fuzzer 发送攻击包时，Agent 监控串口。  
     * 若检测到 Kernel Panic，Agent 自动触发 GPIO 重启电源，并向 Server 报告 "Resilience Fail"。

## **5\. 数据存储架构**

### **5.1 数据库选型**

* **PostgreSQL**: 存储用户、权限、项目、合规矩阵、审计日志。使用 Alembic 管理 Schema 变更。  
* **MongoDB**: 存储 scan\_results (Nmap XML 转换后的 JSON), fuzzing\_logs (非结构化)。  
* **Redis**:  
  1. Celery Broker & Backend.  
  2. 实时日志 Pub/Sub (task:log:{id}).  
  3. 用户 Session 缓存.

## **6\. 接口与鉴权**

### **6.1 鉴权 (OAuth2 / JWT)**

* 使用 FastAPI Security 模块。  
* **Dependency Injection**:  
  async def get\_current\_user(token: str \= Depends(oauth2\_scheme)):  
      \# 解析 JWT，查询 Redis/DB  
      pass

  async def get\_current\_active\_engineer(  
      current\_user: User \= Depends(get\_current\_user)  
  ):  
      if not "engineer" in current\_user.roles:  
          raise HTTPException(403, "需要工程师权限")  
      return current\_user

### **6.2 实时日志 (WebSocket)**

* FastAPI 原生支持 WebSocket。  
* **逻辑**:  
  1. 前端连接 ws://api/ws/tasks/{task\_id}.  
  2. 后端 Loop 读取 Redis Channel task:log:{task\_id}.  
  3. 将消息 push 给 WebSocket 客户端。

## **7\. 部署与运维**

### **7.1 Docker 容器清单 (Updated)**

| 服务名称 | 镜像 | 核心进程 | 资源建议 | 说明 |
| :---- | :---- | :---- | :---- | :---- |
| iot-gateway | nginx:alpine | nginx | 0.5C/512M | 入口网关 |
| iot-backend | **python:3.10-slim** | uvicorn | 2C/4G | **LIMS 核心服务** |
| iot-worker-net | kali-rolling | celery worker | 2C/4G | 网络扫描 Worker |
| iot-worker-fw | fact/core | celery worker | 4C/8G | 固件分析 Worker |
| iot-scheduler | python:3.10-slim | celery beat | 0.5C/512M | 定时任务调度 |
| postgres | postgres:15 | postgres | 2C/4G | 业务库 |
| mongo | mongo:6 | mongod | 2C/4G | 日志库 |
| redis | redis:7 | redis-server | 1C/2G | 消息/缓存 |
| minio | minio/minio | minio | \- | 文件存储 |

### **7.2 环境变量配置**

\# Database  
DATABASE\_URL=postgresql+asyncpg://user:pass@postgres/iot\_db  
MONGO\_URL=mongodb://mongo:27017/iot\_logs

\# Celery  
CELERY\_BROKER\_URL=redis://redis:6379/0  
CELERY\_RESULT\_BACKEND=redis://redis:6379/1

\# Security  
SECRET\_KEY=openssl\_generated\_random\_string  
ACCESS\_TOKEN\_EXPIRE\_MINUTES=60

## **8\. 实施路线图 (Roadmap)**

1. **S0 (基础框架)**:  
   * 搭建 FastAPI 脚手架，配置 SQLAlchemy \+ Alembic。  
   * 实现 RBAC 用户认证模块。  
2. **S1 (核心业务)**:  
   * 实现项目管理、样品库 CRUD。  
   * 设计 EN 18031 合规矩阵数据模型。  
3. **S2 (执行引擎)**:  
   * 配置 Celery，实现 Nmap Wrapper。  
   * 实现 WebSocket 日志回显。  
4. **S3 (报告与高阶)**:  
   * 集成 docxtpl 实现报告一键生成。  
   * 开发树莓派 Agent，联调硬件交互。

文档版本: v2.1 (Unified Python)  
汕头人工智能实验室